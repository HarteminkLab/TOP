
#' Count and normalize ChIP-seq read coverage
#'
#' @param sites_file Candidate sites file
#' @param chip_bam_files ChIP-seq bam files
#' @param chip_idxstats_files ChIP-seq idxstats files.
#' By default, use the corresponding '.idxstats.txt' files in the same directory
#' of the bam files.
#' @param chrom_size_file Chromosome size file
#' @param ref.size ChIP-Seq reference library size (Default: 10 million)
#' @param bedtools_path Path to bedtools executable
# @importFrom  data.table fread
#' @export
#'
count_normalize_chip = function(sites_file,
                                chip_bam_files,
                                chip_idxstats_files,
                                chrom_size_file,
                                ref.size=1e7,
                                bedtools_path='bedtools'){

  if ( Sys.which(bedtools_path) == '' ) {
    stop( 'bedtools could not be executed, set bedtools_path!' )
  }

  if ( length(chip_bam_files) == 0 ) {
    stop('No ChIP-seq files! \n')
  }

  if(missing(chip_idxstats_files)){
    chip_idxstats_files <- paste0(chip_bam_files, '.idxstats.txt')
  }

  # Count total ChIP-seq reads (pool replicates together)
  cat('Counting ChIP-seq read coverage ... \n')
  chip_bam_files <- paste(chip_bam_files, collapse = ' ')
  chip_count_file <- tempfile(pattern = "totalcounts")
  cmd <- paste(bedtools_path, 'coverage -a', sites_file, '-b', chip_bam_files,
               '-counts -sorted -g', chrom_size_file, '>', chip_count_file)
  system(cmd)

  chip_counts <- fread(chip_count_file)
  sites <- as.data.frame(fread(sites_file))
  colnames(chip_counts) <- c(colnames(sites), 'chip')

  # Normalize (scale) ChIP-seq read counts
  cat('Normalize (scale) ChIP-seq library to', ref.size / 1e6, 'million reads... \n')
  total_readsMapped <- sum(sapply(chip_idxstats_files, get_total_reads, select.chr = TRUE))
  scaling_factor <- ref.size / total_readsMapped
  chip_counts$chip <- chip_counts$chip * scaling_factor

  file.remove(chip_count_file)

  return(chip_counts)

}


#' @title Normalize and transform ChIP counts
#'
#' @param chip_counts ChIP-seq counts
#' @param idxstats_file idxstats file generated by samtools
#' @param ref.size ChIP-Seq reference library size (Default: 10 million)
#' @param transform log2 or asinh transform
#' @export
#'
normalize_chip <- function(chip_counts, idxstats_file, ref.size=1e7, transform='asinh') {

  # Count total mapped DNase reads (chr1:22)
  total_readsMapped <- get_total_reads(idxstats_file, select.chr = TRUE)

  # Normalize (scale) ChIP-seq read counts
  cat('Normalize ChIP-seq reads to', ref.size / 1e6, 'million \n')
  scaling_factor <- ref.size / total_readsMapped
  chip_normalized <- chip_counts * scaling_factor

  if (transform == 'asinh') {
    cat(transform, 'transform \n')
    chip_normalized <- asinh(chip_normalized)
  } else if (transform == 'log2') {
    cat(transform, 'transform \n')
    chip_normalized <- log2(chip_normalized+1)
  }

  return(chip_normalized)

}

