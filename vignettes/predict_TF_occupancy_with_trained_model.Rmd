---
title: 'Predict TF occupancy using trained TOP model'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Predict TF occupancy using trained TOP model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = '#>'
)
```

Load TOP R package
---------------------
```{r load-TOP-package, eval=TRUE, message=FALSE, warning=FALSE}
library(TOP)
library(ggplot2)
```

Load data
-----------
The input data should be a data frame, including six columns.

Columns from left to right should be PWM scores and 5 DNase (or ATAC) bins. 

You can follow this [page](data_preparation.html) to prepare the input data. 

```{r load-combined-data, eval=TRUE}
data <- readRDS('../inst/example/processed_data/CTCF_MA0139.1_1e-5.K562.ATAC.M5.combined.data.rds')
head(data,3)
```


Load pre-trained TOP models
--------------------------------
We will provide pre-trained models using ENCODE data 
[here](https://users.cs.duke.edu/~amink/software/).

Load trained TOP model regression coefficients
```{r load-TOP-posterior-mean-coef, eval=TRUE}
TOP_coef <- readRDS('../inst/trained_model_coef/ATAC/TOP_M5_posterior_mean_coef.rds')
summary(TOP_coef)
```

Predict TF occupancy using trained TOP model
------------------------------------------------

Predict CTCF occupancy in K562 cell type using bottom level regression coefficients for CTCF in K562
```{r predict-TOP-mean-coef, eval=TRUE}
res <- predict_TOP(data, 
                   tf_name = 'CTCF',
                   cell_type = 'K562',
                   TOP_coef = TOP_coef, 
                   level = 'bottom',
                   logistic.model = FALSE, 
                   transform = 'asinh')
predictions <- res$predictions
```

Plot predicted occupancy vs. measured occupancy
```{r plot-predicted-measured, eval=TRUE, fig.width=5, fig.height=5}
data_chip <- readRDS('../inst/example/processed_data/CTCF_MA0139.1_1e-5.K562.ATAC.M5.ChIP.combined.data.rds')

scatterplot_predictions(x = asinh(data_chip$chip),
                        y = asinh(predictions$predicted),
                        title = 'Predicting CTCF occupancy in K562 cell',
                        xlab = 'asinh(measured occupancy)',
                        ylab = 'asinh(predicted occupancy)',
                        xlim = c(0,8),
                        ylim = c(0,8))
```

Predict TF binding probability using trained TOP logistic model
------------------------------------------------------------------

Load trained TOP model regression coefficients
```{r load-TOP-logistic-posterior-mean-coef, eval=TRUE}
TOP_logistic_coef <- readRDS('../inst/trained_model_coef/ATAC/TOP_logistic_M5_posterior_mean_coef.rds')
summary(TOP_logistic_coef)
```

Predict CTCF binding probability in K562 cell type using bottom level logistic regression coefficients for CTCF in K562
```{r predict-TOP-logistic-mean-coef, eval=TRUE}
res <- predict_TOP(data, 
                   tf_name = 'CTCF',
                   cell_type = 'K562',
                   TOP_coef = TOP_logistic_coef, 
                   level = 'bottom',
                   logistic.model = TRUE)
predicted.prob <- res$predictions
```

```{r show-TOP-logistic-predictions, eval=TRUE}
head(predicted.prob, 3)

hist(predicted.prob$predicted, main="Distribution of predicted binding probabiliy", xlab="P(bound)")
```

