---
title: 'Predict TF occupancy using trained TOP model'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Predict TF occupancy using trained TOP model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = '#>'
)
```

Load TOP R package
---------------------
```{r load-TOP-package, eval = TRUE, message=FALSE, warning=FALSE}
library(TOP)
library(ggplot2)
```

Input data
-----------
The input data should be a data frame, including six columns.

Columns from left to right should be PWM scores and 5 DNase (or ATAC) bins. 

You can follow this [page](data_preparation.html) to prepare the input data. 

Download pre-trained TOP models
--------------------------------
We will provide pre-trained models using ENCODE data 
[here](https://users.cs.duke.edu/~amink/software/).

Load trained TOP model regression coefficients
```{r load-TOP-posterior-mean-coef, eval=TRUE}
TOP_mean_coef <- readRDS('../inst/trained_model_coef/ATAC/TOP_M5_posterior_mean_coef.rds')
summary(TOP_mean_coef)
```

TF- and cell-type- specific model (bottom level) regression coefficients
```{r show-bottom-level-coef, eval=TRUE}
head(TOP_mean_coef$bottom, 3)
```

TF-specific cell-type-generic model (middle level) regression coefficients
```{r show-middle-level-coef, eval=TRUE}
head(TOP_mean_coef$middle, 3)
```

TF-generic model (top level) regression coefficients
```{r show-top-level-coef, eval=TRUE}
head(TOP_mean_coef$top)
```

Predict TF occupancy using trained TOP model
------------------------------------------------

Load data
```{r load-combined-data, eval=TRUE}
data <- readRDS('../inst/example/processed_data/CTCF_MA0139.1_1e-5.K562.ATAC.M5.combined.data.rds')
head(data,3)
```
Predict CTCF occupancy in K562 cell type using bottom level regression coefficients for CTCF in K562
```{r predict-TOP-mean-coef, eval = TRUE}
# Choose trained regression coefficients (bottom level) for CTCF in K562
model_coef <- TOP_mean_coef$bottom['CTCF.K562',]

data$predicted.occupancy <- predict_TOP(data, 
                                        model_coef, 
                                        posterior.option = 'mean', 
                                        transform = 'asinh')

```

Plot predicted occupancy vs. measured occupancy
```{r plot-predicted-measured, eval=TRUE, fig.width=5, fig.height=5}
data_chip <- readRDS('../inst/example/processed_data/CTCF_MA0139.1_1e-5.K562.ATAC.M5.ChIP.combined.data.rds')

scatterplot_predictions(x = asinh(data_chip$chip),
                        y = asinh(data$predicted.occupancy),
                        title = 'Predicting CTCF occupancy in K562 cell',
                        xlab = 'asinh(measured occupancy)',
                        ylab = 'asinh(predicted occupancy)',
                        xlim = c(0,8),
                        ylim = c(0,8))
```

Predict TF binding probability using trained TOP logistic model
------------------------------------------------------------------

Load trained TOP model regression coefficients
```{r load-TOP-logistic-posterior-mean-coef, eval=TRUE}
TOP_logistic_mean_coef <- readRDS('../inst/trained_model_coef/ATAC/TOP_logistic_M5_posterior_mean_coef.rds')
summary(TOP_logistic_mean_coef)
```

```{r predict-TOP-logistic-mean-coef, eval = TRUE}
# Choose trained regression coefficients (bottom level) for CTCF in K562
model_coef <- TOP_logistic_mean_coef$bottom['CTCF.K562',]

data$predicted.prob <- predict_TOP(data, 
                                   model_coef, 
                                   logistic.model = TRUE, 
                                   posterior.option = 'mean')

```
```{r show-TOP-predictions, eval = TRUE}
head(data, 3)
```

<!-- Plot predicted binding probability vs. asinh(predicted occupancy) -->
<!-- ```{r plot-predicted-prob-occupancy, eval=TRUE, fig.width=5, fig.height=3} -->
<!-- scatterplot(x=asinh(data$predicted.occupancy), y=data$predicted.prob,  -->
<!--             xlab='asinh(predicted occupancy)', ylab='P(bound)') -->
<!-- ``` -->

