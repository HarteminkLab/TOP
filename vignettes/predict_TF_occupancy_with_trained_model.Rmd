---
title: 'Predict TF occupancy using trained TOP model'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Predict TF occupancy using trained TOP model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = '#>'
)
```

Load TOP R package
---------------------
```{r load-TOP-package, eval=TRUE, message=FALSE, warning=FALSE}
library(TOP)
library(ggplot2)
```

Load data
-----------

To make predictions using trained TOP models, 
we first need to prepare the input data as a data frame, with six columns.

Columns from left to right are PWM scores and five DNase (or ATAC) bins. 

You can follow this [page](data_preparation.html) to prepare the input data. 

Let's load an example ATAC-seq data to predict CTCF occupancy in K562 cell type. 

This data contains binned ATAC-seq counts around CTCF motif matches in chr1. 
```{r load-combined-data, eval=TRUE, include=FALSE}
data <- readRDS(system.file("extdata/example_data", "CTCF.K562.ATAC.chip.example.data.rds", package = "TOP"))
cols <- c('chr','start','end','name','pwm.score','strand','p.value', paste0('bin', 1:5))
data <- data[cols]
```

```{r, eval=TRUE}
head(data,3)
```


Load pre-trained TOP models
--------------------------------

We have trained models for DNase-seq and ATAC-seq using ENCODE data. 

The pre-trained model parameters can be downloaded from 
[here](https://users.cs.duke.edu/~amink/software/).

Predict TF occupancy using trained TOP model
------------------------------------------------

We can make predictions using the posterior mean of 
pre-trained TOP model regression coefficients for ATAC-seq. 

```{r load-TOP-posterior-mean-coef, eval=TRUE}
TOP_coef <- readRDS(system.file("extdata/trained_model_coef/ATAC", "TOP_M5_posterior_mean_coef.rds", package = "TOP"))
```

Now we can predict CTCF occupancy in K562 cell type using the `predict_TOP` function:

We can choose the "bottom" level regression coefficients 
as we have CTCF ChIP data from K562 cell type in our training set. 
```{r predict-TOP-mean-coef-bottom, eval=TRUE}
TOP_result <- predict_TOP(data, 
                          TOP_coef = TOP_coef, 
                          tf_name = 'CTCF', 
                          cell_type = 'K562', 
                          level = 'bottom', 
                          logistic_model = FALSE,
                          transform = 'asinh') 
```

Or, we can select the "best" available level of coefficients 
for the TF and cell type of interest. 
In this case, the "bottom" level is the best level.
```{r predict-TOP-mean-coef-best, eval=TRUE}
TOP_result <- predict_TOP(data, 
                          TOP_coef = TOP_coef, 
                          tf_name = 'CTCF', 
                          cell_type = 'K562', 
                          level = 'best', 
                          logistic_model = FALSE, 
                          transform = 'asinh')
```
This result contains a list with the level of model, 
regression coefficients (posterior mean) used to make predictions, 
and predictions of TF occupancy. 

The prediction result contains the training data together with predicted 
TF occupancy for each candidate site:
```{r}
TOP_predictions <- TOP_result$predictions

head(TOP_predictions, 5)
```

We can plot the predicted occupancy vs. measured occupancy
```{r plot-predicted-measured, eval=TRUE, fig.width=5, fig.height=5}
data_chip <- readRDS(system.file("extdata/example_data", "CTCF.K562.ATAC.chip.example.data.rds", package = "TOP"))

scatterplot_predictions(x = asinh(data_chip$chip),
                        y = asinh(TOP_predictions$predicted),
                        title = 'Predicting CTCF occupancy in K562 cell',
                        xlab = 'asinh(measured occupancy)',
                        ylab = 'asinh(predicted occupancy using bottom level coefficients)',
                        xlim = c(0,8),
                        ylim = c(0,8))
```

We can also try the "middle" level regression coefficients for CTCF, 
which are cell-type generic, thus could be used to predict CTCF in any cell types.
```{r predict-TOP-mean-coef-middle, eval=TRUE}
TOP_middle_result <- predict_TOP(data, 
                                 TOP_coef = TOP_coef, 
                                 tf_name = 'CTCF', 
                                 level = 'middle', 
                                 logistic_model = FALSE, 
                                 transform = 'asinh') 

TOP_middle_predictions <- TOP_middle_result$predictions
```

We can see the performance of the "middle" level model is very close to the "bottom" level.
```{r plot-predicted-measured-middle, eval=TRUE, fig.width=5, fig.height=5}
scatterplot_predictions(x = asinh(data_chip$chip),
                        y = asinh(TOP_middle_predictions$predicted),
                        title = 'Predicting CTCF occupancy in K562 cell',
                        xlab = 'asinh(measured occupancy)',
                        ylab = 'asinh(predicted occupancy using middle level coefficients)',
                        xlim = c(0,8),
                        ylim = c(0,8))
```


Predict TF binding probability using trained TOP logistic model
------------------------------------------------------------------

We can also predict TF binding probability for these candidate sites using 
pre-trained TOP logistic model.

Load pre-trained TOP logistic regression coefficients:
```{r load-TOP-logistic-posterior-mean-coef, eval=TRUE}
TOP_logistic_coef <- readRDS(system.file("extdata/trained_model_coef/ATAC", "TOP_logistic_M5_posterior_mean_coef.rds", package = "TOP"))
```

Predict CTCF binding probability in K562 using the "bottom" level logistic model:
```{r predict-TOP-logistic-mean-coef, eval=TRUE}
TOP_result <- predict_TOP(data, 
                          TOP_coef = TOP_logistic_coef, 
                          tf_name = 'CTCF',
                          cell_type = 'K562',
                          level = 'bottom',
                          logistic_model = TRUE)
predicted.prob <- TOP_result$predictions

head(predicted.prob, 5)
```


